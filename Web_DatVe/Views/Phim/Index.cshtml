@model Web_DatVe.Models.ViewModels.PagingModel<Web_DatVe.Models.PHIM>
@using System
@using System.Collections.Generic
@using System.Linq
@{
    ViewBag.Title = "Danh sách phim";

    // Ép kiểu an toàn, tránh NullReference nếu ViewBag chưa được gán
    IEnumerable<string> theLoaiList = ViewBag.TheLoaiList as IEnumerable<string> ?? Enumerable.Empty<string>();
    IEnumerable<int> namList = ViewBag.NamList as IEnumerable<int> ?? Enumerable.Empty<int>();
    IEnumerable<string> quocGiaList = ViewBag.QuocGiaList as IEnumerable<string> ?? Enumerable.Empty<string>();
}

<h2 class="mb-3">Phim đang chiếu & sắp chiếu</h2>

<!-- BỘ LỌC PHIM -->
<div class="filter-box p-3 mb-4">
    <form method="get" class="row g-3">
        <!-- Ẩn tham số page khi submit form (reset về trang 1) -->
        <input type="hidden" name="page" value="1" />

        <!-- Tìm kiếm -->
        <div class="col-md-12 mb-3">
            <label>Tìm kiếm</label>
            <input type="text" name="search" class="form-control" placeholder="Nhập tên phim..." value="@ViewBag.Search" />
        </div>

        <!-- Thể loại -->
        <div class="col-md-4">
            <label>Thể loại</label>
            <select id="theLoaiSelect" name="theloai" class="form-select">
                <option value="">Tất cả</option>
            </select>
        </div>

        <!-- Năm -->
        <div class="col-md-4">
            <label>Năm</label>
            <select name="nam" class="form-select">
                <option value="">Tất cả</option>
                @foreach (var year in namList)
                {
                    var isSelected = string.Equals(Request["nam"], year.ToString(), StringComparison.OrdinalIgnoreCase);
                    <option value="@year" @(isSelected ? "selected=\"selected\"" : "")>@year</option>
                }
            </select>
        </div>

        <!-- Quốc gia -->
        <div class="col-md-4">
            <label>Quốc gia</label>
            <select name="quocgia" class="form-select">
                <option value="">Tất cả</option>
                @foreach (var qg in quocGiaList)
                {
                    var isSelected = string.Equals(Request["quocgia"], qg as string, StringComparison.OrdinalIgnoreCase);
                    <option value="@qg" @(isSelected ? "selected=\"selected\"" : "")>@qg</option>
                }
            </select>
        </div>

        <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-danger px-4">Lọc phim</button>
            <a href="/Phim" class="btn btn-outline-secondary px-4">Xóa bộ lọc</a>
        </div>

    </form>
</div>

<!-- DANH SÁCH PHIM -->
<div class="movie-grid">
    @foreach (var p in Model.Results)
    {
        <div class="movie-card">
            <img src="@Url.Content("~/Content/images/" + p.Poster)" alt="@p.TenPhim" />
            <div class="movie-info">
                <h5>@p.TenPhim</h5>
                <a href="/Phim/ChiTiet/@p.MaPhim" class="btn-book">Xem chi tiết</a>
            </div>
        </div>
    }
</div>

@if (Model.Results.Count == 0)
{
    <div class="alert alert-info text-center mt-4">
        <p>Không tìm thấy phim nào.</p>
    </div>
}

<!-- PHÂN TRANG -->
@if (Model.PageCount > 1)
{
    <nav aria-label="Phân trang" class="mt-4">
        <ul class="pagination justify-content-center">
            @{
                int currentPage = Model.CurrentPage;
                int totalPages = Model.PageCount;
                string search = ViewBag.Search as string ?? "";
                string theloai = ViewBag.TheLoai as string ?? "";
                int? nam = ViewBag.Nam as int?;
                string quocgia = ViewBag.QuocGia as string ?? "";

                // Nút Previous
                if (currentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=@(currentPage - 1)&search=@search&theloai=@theloai&nam=@nam&quocgia=@quocgia">Trước</a>
                    </li>
                }
                else
                {
                    <li class="page-item disabled">
                        <span class="page-link">Trước</span>
                    </li>
                }

                // Hiển thị số trang
                int startPage = Math.Max(1, currentPage - 2);
                int endPage = Math.Min(totalPages, currentPage + 2);

                if (startPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=1&search=@search&theloai=@theloai&nam=@nam&quocgia=@quocgia">1</a>
                    </li>
                    if (startPage > 2)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }

                for (int i = startPage; i <= endPage; i++)
                {
                    if (i == currentPage)
                    {
                        <li class="page-item active">
                            <span class="page-link">@i</span>
                        </li>
                    }
                    else
                    {
                        <li class="page-item">
                            <a class="page-link" href="?page=@i&search=@search&theloai=@theloai&nam=@nam&quocgia=@quocgia">@i</a>
                        </li>
                    }
                }

                if (endPage < totalPages)
                {
                    if (endPage < totalPages - 1)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                    <li class="page-item">
                        <a class="page-link" href="?page=@totalPages&search=@search&theloai=@theloai&nam=@nam&quocgia=@quocgia">@totalPages</a>
                    </li>
                }

                // Nút Next
                if (currentPage < totalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=@(currentPage + 1)&search=@search&theloai=@theloai&nam=@nam&quocgia=@quocgia">Sau</a>
                    </li>
                }
                else
                {
                    <li class="page-item disabled">
                        <span class="page-link">Sau</span>
                    </li>
                }
            }
        </ul>
    </nav>

    <div class="text-center text-muted mt-2">
        <small>Trang @Model.CurrentPage / @Model.PageCount - Tổng @Model.RowCount phim</small>
    </div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {

        let selected = "@(ViewBag.TheLoai ?? "")";   // giữ lựa chọn sau khi lọc

        $.get("/api/theloai/list", function (data) {

            data.forEach(function (tl) {
                let opt = $("<option>", {
                    value: tl,
                    text: tl
                });

                if (tl === selected) {
                    opt.attr("selected", "selected");
                }

                $("#theLoaiSelect").append(opt);
            });

        }).fail(function (err) {
            console.log("Lỗi load thể loại:", err);
        });

    });
</script>
