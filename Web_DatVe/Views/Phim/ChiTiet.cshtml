@model Web_DatVe.Models.ViewModels.MovieDetailVM
@{
    ViewBag.Title = Model.Phim.TenPhim;
}

<div class="row">

    <!-- POSTER -->
    <div class="col-md-4">
        <img src="@Url.Content("~/Content/images/" + Model.Phim.Poster)"
             class="img-fluid rounded mb-3 shadow" />
    </div>

    <!-- INFO -->
    <div class="col-md-8">
        <h2 class="text-danger">@Model.Phim.TenPhim</h2>

        <p><b>Thể loại:</b> @Model.Phim.TheLoai</p>
        <p><b>Thời lượng:</b> @Model.Phim.ThoiLuong phút</p>
        <p><b>Ngày khởi chiếu:</b> @(Model.Phim.NgayKhoiChieu.HasValue 
                ? Model.Phim.NgayKhoiChieu.Value.ToString("dd/MM/yyyy") 
                : "Đang cập nhật")</p>
        <p><b>Quốc gia:</b> @Model.Phim.QuocGia</p>

        <h5 class="mt-3">Nội dung phim:</h5>
        <p>@Model.Phim.MoTa</p>
    </div>
</div>

<hr class="my-4" />

<!-- TRAILER -->
@if (!string.IsNullOrWhiteSpace(Model.Phim.Trailer))
{
    <h3 class="mb-3">Trailer</h3>
    <div class="ratio ratio-16x9 mb-4">
        @{
            string embedUrl = Model.Phim.Trailer.Trim();
            
            // Chuyển đổi URL YouTube thông thường sang embed URL
            if (embedUrl.Contains("youtube.com/watch?v="))
            {
                int startIndex = embedUrl.IndexOf("v=") + 2;
                int endIndex = embedUrl.IndexOf("&", startIndex);
                if (endIndex == -1) { endIndex = embedUrl.Length; }
                string videoId = embedUrl.Substring(startIndex, endIndex - startIndex);
                embedUrl = "https://www.youtube.com/embed/" + videoId;
            }
            else if (embedUrl.Contains("youtu.be/"))
            {
                int startIndex = embedUrl.IndexOf("youtu.be/") + 9;
                int endIndex = embedUrl.IndexOf("?", startIndex);
                if (endIndex == -1) { endIndex = embedUrl.Length; }
                string videoId = embedUrl.Substring(startIndex, endIndex - startIndex);
                embedUrl = "https://www.youtube.com/embed/" + videoId;
            }
            // Nếu đã là embed URL thì giữ nguyên
            else if (!embedUrl.Contains("youtube.com/embed/") && !embedUrl.Contains("youtube-nocookie.com/embed/"))
            {
                // Nếu là URL khác, thử tìm video ID từ các pattern khác
                if (embedUrl.Contains("/watch?v="))
                {
                    int startIndex = embedUrl.IndexOf("/watch?v=") + 9;
                    int endIndex = embedUrl.IndexOf("&", startIndex);
                    if (endIndex == -1) { endIndex = embedUrl.Length; }
                    string videoId = embedUrl.Substring(startIndex, endIndex - startIndex);
                    embedUrl = "https://www.youtube.com/embed/" + videoId;
                }
            }
        }
        <iframe src="@embedUrl" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                allowfullscreen
                style="border-radius: 8px;"></iframe>
    </div>
}

<!-- LỊCH CHIẾU -->
<h3 class="my-4">Lịch chiếu</h3>

@if (!Model.SuatChieu.Any())
{
    <p class="text-muted">Hiện chưa có lịch chiếu.</p>
}
else
{
    <div class="row g-3">
        @foreach (var s in Model.SuatChieu)
        {
            <div class="col-md-3 col-sm-6">
                <div class="showtime-card p-3 border rounded shadow-sm bg-light h-100 d-flex flex-column">
                    <div class="mb-2">
                        <b class="d-block">@s.ThoiGianBatDau.ToString("HH:mm")</b>
                        <small class="text-muted">@s.ThoiGianBatDau.ToString("dd/MM/yyyy")</small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Giá: <strong class="text-danger">@string.Format("{0:N0}", s.GiaVe) đ</strong></small>
                    </div>
                    <a href="/Ghe/ChonGhe/@s.MaSuat" class="btn btn-danger btn-sm mt-auto w-100">Đặt vé</a>
                </div>
            </div>
        }
    </div>
}

<!-- PHIM LIÊN QUAN -->
@if (Model.PhimLienQuan != null && Model.PhimLienQuan.Any())
{
    <hr class="my-5" />
    <h3 class="mb-3">Phim liên quan</h3>

    <div class="row g-3">
        @foreach (var p in Model.PhimLienQuan)
        {
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 shadow-sm related-movie-card">
                    <a href="/Phim/ChiTiet/@p.MaPhim" class="text-decoration-none text-dark">
                        <img src="@Url.Content("~/Content/images/" + p.Poster)"
                             class="card-img-top"
                             alt="@p.TenPhim" />
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate" title="@p.TenPhim">@p.TenPhim</h6>
                            <small class="text-muted mb-2">@p.TheLoai</small>
                            @if (p.NgayKhoiChieu.HasValue)
                            {
                                <small class="text-muted">Khởi chiếu: @p.NgayKhoiChieu.Value.ToString("dd/MM/yyyy")</small>
                            }
                        </div>
                    </a>
                </div>
            </div>
        }
    </div>
}